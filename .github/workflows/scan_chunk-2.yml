name: Scan_chunk-2

on:
  workflow_run:
    workflows: ["1é¢„å¤„ç†-ä¸‹è½½-åˆå¹¶-åˆ†å‰²-ç”Ÿæˆ"]     # ç›‘å¬è¯¥å·¥ä½œæµå®Œæˆåè§¦å‘
    types:
      - completed                               # ä»…å½“æŒ‡å®šå·¥ä½œæµå®Œæˆæ—¶è§¦å‘
  workflow_dispatch:                            # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write                              # å…è®¸å†™å…¥ä»“åº“å†…å®¹

jobs:
  scan_chunk-2:
    runs-on: ubuntu-latest                     # ä½¿ç”¨æœ€æ–°Ubuntuç¯å¢ƒè¿è¡Œ
    steps:
      - name: Checkout repository              # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: Setup Python 3.11                  # å®‰è£…Python 3.11ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ffmpeg                     # å®‰è£…ffmpegå·¥å…·ï¼Œå‘½ä»¤è¡Œè§†é¢‘å¤„ç†å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
        
      - name: Cache pip
        uses: actions/cache@v3         # ç¼“å­˜pipåŒ…ç›®å½•ï¼ŒåŠ é€Ÿå®‰è£…
        with:
          path: ~/.cache/pip
          key: ${ runner.os }-pip-${ hashFiles('requirements.txt') }  # ä¾æ®requirements.txtç”Ÿæˆç¼“å­˜key
          restore-keys: |
            ${ runner.os }-pip-       # æ¢å¤æ—¶åŒ¹é…å‰ç¼€
            
      - name: Install dependencies               # å®‰è£…Pythonä¾èµ–ï¼Œæ¥è‡ªrequirements.txt
        run: pip install -r requirements.txt

      - name: Run fast scan for chunk-2              # è¿è¡Œå¿«é€Ÿæ‰«æè„šæœ¬ï¼Œå¤„ç†å¯¹åº”chunkæ–‡ä»¶
        run: |
          mkdir -p output/middle/fast/ok output/middle/fast/not   # åˆ›å»ºç»“æœè¾“å‡ºç›®å½•
          python scripts/6.1_fast_scan.py \                         # æ‰§è¡Œå¿«é€Ÿæ‰«æè„šæœ¬
            --input output/middle/chunk/chunk-2.csv \                 # è¾“å…¥å¯¹åº”chunkæ–‡ä»¶
            --output output/middle/fast/ok/fast_chunk-2.csv \         # åˆæ ¼è¾“å‡ºè·¯å¾„
            --invalid output/middle/fast/not/fast_chunk-2-invalid.csv # ä¸åˆæ ¼è¾“å‡ºè·¯å¾„
            
      - name: Run deep scan for chunk-2              # è¿è¡Œæ·±åº¦æ‰«æè„šæœ¬ï¼Œè¿›ä¸€æ­¥æ ¡éªŒå¿«é€Ÿæ‰«æåˆæ ¼æ•°æ®
        run: |
          mkdir -p output/middle/deep/ok output/middle/deep/not   # åˆ›å»ºæ·±åº¦æ‰«æç»“æœç›®å½•
          python scripts/6.2_deep_scan.py \                        # æ‰§è¡Œæ·±åº¦æ‰«æè„šæœ¬
            --input output/middle/fast/ok/fast_chunk-2.csv \          # è¾“å…¥å¿«é€Ÿæ‰«æåˆæ ¼æ–‡ä»¶
            --output output/middle/deep/ok/deep_chunk-2.csv \         # æ·±åº¦æ‰«æåˆæ ¼è¾“å‡ºè·¯å¾„
            --invalid output/middle/deep/not/deep_chunk-2-invalid.csv # æ·±åº¦æ‰«æä¸åˆæ ¼è¾“å‡ºè·¯å¾„

      - name: Run final scan for chunk-2             # è¿è¡Œæœ€ç»ˆæ‰«æè„šæœ¬ï¼Œåšæœ€åä¸€æ­¥éªŒè¯å’Œå¤„ç†
        run: |
          mkdir -p output/middle/final/ok output/middle/final/not   # åˆ›å»ºæœ€ç»ˆç»“æœç›®å½•
          python scripts/6.3_final_scan.py \                        # æ‰§è¡Œæœ€ç»ˆæ‰«æè„šæœ¬
            --input output/middle/deep/ok/deep_chunk-2.csv \           # è¾“å…¥æ·±åº¦æ‰«æåˆæ ¼æ–‡ä»¶
            --output output/middle/final/ok/final_chunk-2.csv \        # æœ€ç»ˆåˆæ ¼è¾“å‡ºè·¯å¾„
            --invalid output/middle/final/not/final_chunk-2-invalid.csv # æœ€ç»ˆä¸åˆæ ¼è¾“å‡ºè·¯å¾„
            --cache_dir output/cache                                # æŒ‡å®šç¼“å­˜ç›®å½•

      - name: Commit and Push Outputs               # æäº¤å¹¶æ¨é€æ‰«æç»“æœ
        run: |
          git config user.name "github-actions[bot]"               # è®¾ç½®æäº¤ç”¨æˆ·å
          git config user.email "github-actions[bot]@users.noreply.github.com" # è®¾ç½®æäº¤é‚®ç®±

          git add output/cache \                                    # æ·»åŠ ç¼“å­˜ç›®å½•åŠæ‰«æç»“æœç›®å½•
                  output/middle/fast                   output/middle/deep                   output/middle/final

          if git diff --cached --quiet; then                      # å¦‚æœæ²¡æœ‰å˜æ›´ï¼Œè¾“å‡ºæç¤ºå¹¶é€€å‡º
            echo "No output updates."
            exit 0
          fi

          git commit -m "Update scan outputs for chunk-2 [skip ci]"   # æäº¤å˜æ›´ï¼Œè·³è¿‡CIè§¦å‘

          MAX_RETRIES=5                                           # æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ä¸º5
          COUNT=1                                                 # åˆå§‹åŒ–é‡è¯•è®¡æ•°å™¨ä¸º1

          until git push --quiet; do                              # å¾ªç¯æ‰§è¡Œpushï¼Œç›´åˆ°æˆåŠŸæˆ–è¶…è¿‡é‡è¯•æ¬¡æ•°
            echo "Push failed (attempt $COUNT/$MAX_RETRIES), retrying..."

            git stash push -m "auto-stash" || true               # ä¿å­˜å½“å‰å˜æ›´åˆ°stashï¼Œé˜²æ­¢å†²çª
            git pull --rebase --quiet || true                    # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç å¹¶rebase
            git stash pop || true                                 # æ¢å¤stashå†…å®¹

            COUNT=$((COUNT+1))                                    # é‡è¯•è®¡æ•°å™¨åŠ 1
            if [ $COUNT -gt $MAX_RETRIES ]; then                  # å¦‚æœè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åˆ™é€€å‡ºå¹¶æŠ¥é”™
              echo "ğŸ”¥ Push failed after $MAX_RETRIES attempts."
              exit 1
            fi

            sleep 2                                              # ç­‰å¾…2ç§’åé‡è¯•
          done

          echo "Push outputs succeeded."                         # æ¨é€æˆåŠŸæç¤º
