name: 1_下载源文件

on:
  workflow_dispatch:         # 手动触发工作流
  schedule:
    - cron: '05 16 * * *'   # 定时触发：每天 UTC 时间16:05（北京时间0:05）

permissions:
  contents: write           # 允许写入仓库内容

jobs:
  download_all_m3u:
    name: 下载全部M3U
    runs-on: ubuntu-latest  # 使用最新的Ubuntu虚拟环境运行作业
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4  # 检出当前仓库代码
        with:
          fetch-depth: 0           # 完整克隆历史，避免浅克隆
          persist-credentials: true # 持久化凭据，方便后续git操作

      - name: Setup Python
        uses: actions/setup-python@v5  # 安装指定版本的Python环境
        with:
          python-version: '3.11'       # Python 3.11版本

      - name: Cache pip
        uses: actions/cache@v3          # 缓存pip下载的包，加快后续构建速度
        with:
          path: ~/.cache/pip            # 缓存pip的缓存目录
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }} # 缓存key，根据requirements.txt内容生成哈希
          restore-keys: |
            ${{ runner.os }}-pip-      # 还原时可匹配的前缀key

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # 升级pip
          pip install -r requirements.txt       # 安装项目依赖库

      - name: Ensure output directories exist
        run: |
          mkdir -p input/source          # 确保输入输出目录存在
          mkdir -p input/download/my
          mkdir -p input/download/net
          mkdir -p scripts               # scripts目录也创建

      - name: Run M3U download script
        run: python scripts/1_download_m3u.py  # 运行下载M3U的python脚本

      - name: Fix permissions before commit
        run: chmod -R u+rw input/download       # 修改下载文件夹权限，确保当前用户有读写权限

      - name: Commit & Push results
        run: |
          git config user.name "github-actions[bot]"                 # 设置git用户名
          git config user.email "github-actions[bot]@users.noreply.github.com"  # 设置git邮箱

          git add input/download                                     # 添加下载目录到git暂存区

          if git diff --cached --quiet; then                         # 判断是否有改动需要提交
            echo "✅ No changes to commit."                          # 无改动则退出
            exit 0
          fi

          git commit -m "Update M3U sources [ci skip]"               # 有改动则提交，并跳过CI触发

          git pull --rebase origin main                               # 拉取远程最新代码，rebase处理避免冲突
          git push origin main                                        # 推送本地提交到远程main分支
