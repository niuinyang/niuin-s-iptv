name: C-åˆå¹¶ç¼“å­˜  # workflowåç§°

on:
  workflow_run:
    workflows:
      - "B-æ£€æŸ¥ç¼“å­˜workflowæ‰§è¡Œå®Œæ¯•åˆå¹¶"
    types:
      - completed
  workflow_dispatch:

jobs:
  merge-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PUSH_TOKEN1 }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run merge cache script
        run: python scripts/D_merge_cache.py

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes before commit
        run: git pull --rebase --autostash origin main

      - name: Stage merged cache files (verify)
        run: |
          if [ ! -f output/cache/total_cache.json ] || [ ! -f output/cache/merge_record.json ]; then
            echo "âŒ ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤æ­¥éª¤"
            exit 0
          fi

          git add output/cache/total_cache.json output/cache/merge_record.json || true

          if git diff --cached --quiet; then
            echo "âŒ æ— æ”¹åŠ¨ï¼Œè·³è¿‡åç»­æ“ä½œ"
            exit 0
          else
            echo "âœ… æ£€æµ‹åˆ°ç¼“å­˜æ–‡ä»¶å˜åŠ¨"
          fi

      - name: Cleanup chunk cache older than 3 days
        run: |
          set -e
          BASE_DIR="output/cache/chunk"
          KEEP_DAYS=3
          [ -d "$BASE_DIR" ] || exit 0

          THRESHOLD_DATE=$(date -d "-${KEEP_DAYS} days" +"%Y%m%d")
          echo "ğŸ§¹ æ¸…ç† $THRESHOLD_DATE ä¹‹å‰çš„ chunk ç¼“å­˜ç›®å½•"

          for dir in "$BASE_DIR"/*; do
            [ -d "$dir" ] || continue
            name=$(basename "$dir")
            if [[ "$name" =~ ^[0-9]{8}$ ]] && [ "$name" -lt "$THRESHOLD_DATE" ]; then
              rm -rf "$dir"
            fi
          done

      - name: Add and commit merged cache files
        run: |
          git add output/cache/total_cache.json output/cache/merge_record.json || true
          if ! git diff --cached --quiet; then
            git commit -m "è‡ªåŠ¨åˆå¹¶ç¼“å­˜æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
          else
            echo "æ— å˜åŠ¨ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

      - name: Push changes with retry
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN1 }}
        run: |
          MAX_RETRIES=3
          count=0
          git remote set-url origin https://x-access-token:${PUSH_TOKEN}@github.com/niuinyang/niuin-s-iptv.git

          until [ $count -ge $MAX_RETRIES ]
          do
            git push origin main && break
            count=$((count+1))
            echo "Pushå¤±è´¥ï¼Œé‡è¯•ç¬¬ $count æ¬¡..."
            sleep 5
          done

          if [ $count -eq $MAX_RETRIES ]; then
            exit 1
          fi
