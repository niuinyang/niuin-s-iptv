name: C-åˆå¹¶ç¼“å­˜  # workflowåç§°

on:
  workflow_run:
    workflows:
      - "B-æ£€æŸ¥ç¼“å­˜workflowæ‰§è¡Œå®Œæ¯•åˆå¹¶"  # ç›‘å¬æ­¤workflowæ‰§è¡Œå®Œæ¯•åè§¦å‘æœ¬workflow
    types:
      - completed                   # ä»…åœ¨è¢«ç›‘å¬workflowå®Œæˆåè§¦å‘
  workflow_dispatch:               # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  merge-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install zoneinfo || true
          pip install -r requirements.txt || true

      - name: Run merge cache script
        run: python scripts/D_merge_cache.py

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes before commit
        run: git pull --rebase --autostash origin main

      # ========= ä¿®æ”¹ step 1ï¼šå…ˆæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå†æ£€æµ‹æ˜¯å¦æœ‰å˜åŠ¨ =========
      - name: Stage merged cache files (verify)
        run: |
          # å…ˆæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f output/cache/total_cache.json ] || [ ! -f output/cache/merge_record.json ]; then
            echo "âŒ ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤æ­¥éª¤"
            exit 0
          fi

          git add output/cache/total_cache.json output/cache/merge_record.json || true

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if git diff --cached --quiet; then
            echo "âŒ åˆå¹¶ç¼“å­˜æ–‡ä»¶æœªæˆåŠŸåŠ å…¥æš‚å­˜åŒºæˆ–æ— æ”¹åŠ¨ï¼Œç»ˆæ­¢åç»­æ“ä½œ"
            exit 0
          else
            echo "âœ… åˆå¹¶ç¼“å­˜æ–‡ä»¶å·²æˆåŠŸåŠ å…¥æš‚å­˜åŒº"
          fi

      # ========= ä¿æŒåŸæœ‰æ¸…ç†é€»è¾‘ =========
      - name: Cleanup chunk cache older than 3 days
        run: |
          set -e

          BASE_DIR="output/cache/chunk"
          KEEP_DAYS=3

          [ -d "$BASE_DIR" ] || exit 0

          THRESHOLD_DATE=$(date -d "-${KEEP_DAYS} days" +"%Y%m%d")
          echo "ğŸ§¹ æ¸…ç† $THRESHOLD_DATE ä¹‹å‰çš„ chunk ç¼“å­˜ç›®å½•"

          for dir in "$BASE_DIR"/*; do
            [ -d "$dir" ] || continue
            name=$(basename "$dir")

            if [[ "$name" =~ ^[0-9]{8}$ ]] && [ "$name" -lt "$THRESHOLD_DATE" ]; then
              echo "åˆ é™¤æ—§ç¼“å­˜ç›®å½•: $dir"
              rm -rf "$dir"
            fi
          done

      - name: Add and commit merged cache files
        run: |
          # å†æ¬¡æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f output/cache/total_cache.json ] || [ ! -f output/cache/merge_record.json ]; then
            echo "âŒ ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          git add output/cache/total_cache.json output/cache/merge_record.json || true
          if ! git diff --cached --quiet; then
            git commit -m "è‡ªåŠ¨åˆå¹¶ç¼“å­˜æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
          else
            echo "æ— å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 0
          fi

      - name: Push changes with retry
        run: |
          MAX_RETRIES=3
          count=0
          until [ $count -ge $MAX_RETRIES ]
          do
            git push origin main && break
            count=$((count+1))
            echo "Pushå¤±è´¥ï¼Œé‡è¯•ç¬¬ $count æ¬¡..."
            sleep 5
          done
          if [ $count -eq $MAX_RETRIES ]; then
            echo "Pushæ“ä½œå¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $MAX_RETRIES"
            exit 1
          fi
